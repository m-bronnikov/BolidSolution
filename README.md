# Многопоточное перемножение матриц

-----

## Задание 

### Формулировка

Даны два файла с квадратными матрицами целых чисел 100 на 100. Требуется реализовать многопоточное перемножение этих матриц. Результат должен записываться в третий файл. Количество потоков для перемножения задается при старте.  Работа с матрицами должна быть оформлена в виде классов с перегруженными операторами. Работа с потоками также должна быть оформлена в виде классов.


### Язык реализации 

C++


## Реализация

### Многопоточность

Для работы с потоками был реализован [Пул Потоков](myself/ThreadController.h), который позволяет не тратить ресурсы каждый раз на создание потоков, а держать указанное количесвто в рабочем состоянии. Потоки постоянно ожидают появления в очереди новой задачи и при её появлении один из них сразу начинает её выполнение. Для добавления функции вместе с параметрами в очередь на выполнение пулом реализован метод *to_work*, принимающий функцтор с переменным списком параметров.

В будущем, возможно, следует добавить в класс методы для увеличения/уменьшения количества рабочих потоков.

### Матрица

[Реализация матрицы](myself/QuadratMatrix.h) в классе **QudratMatrix** довольно примитивно по содержанию за исключением наличия перегруженных операторов для упрощенного взаимодействия и наличия статического элемента класса - пула потоков, при помощи которого вычисляется умножение матриц. Перемножение матриц разбивается  на подзадачи, выполняемые в разных потоках, а именно каждый поток отдельно строки результирующей матрицы, передавая соответствующую функцию в пул. Ввод и вывод матриц реализован с  помощью переопределения операторов ввода и вывода.

К минусам реализации стоит отнести, что я пока что не стал добавлять синхронную реализацию перемножения матриц при указании соответствующего пользовательского параметра. Необходимо перед работой с классом заранее инициализировать пул желаемым количеством потоков. Впрочем, эти недосатки легко решаются при необходимости.

## Работа с классом

### Основные моменты 

Для демонстрации работы с классом добавлен файл [example.cpp](example.cpp). Рассмотрим основные моменты:

- Количество добавляемых потоков для демнострационного примера можно указать при запуске как аргумент командной строки.

- Перед началом работы с классом инициализируется пул количеством потоков. Пул один для всех объектов класса!
```
myself::QuadratMatrix::create_threads(threads);
```

- Есть несколько вариаций конструкторов, в том числе и инициализирующих матрицу значением из файла. В данном случае используется конструктор нулевой  матрицы.
```
myself::QuadratMatrix left;
myself::QuadratMatrix right;
```

- Перегружен оператор для доступа по индексу
```
left[i][j] = rand();
right[i][j] = rand();
```

- Перегружен оператор умножения для выполнения асинхронного произведения 2-ух матриц. Также здесь используется конструктор копирования для инициализации результата.
```
myself::QuadratMatrix ans = left * right;
```

- Добавлены методы для чтения  и записи матриц в файлы, которые используют внутри себя перегруженные методы потоковых ввода и вывода соответственно.
```
ans.to_file(ans_path);
```




## Тестирование

### Суть

С помощью файла [generator.py](generator.py) на языке *Python* я  сгенерировал $9$ случайных пар матриц с помощью библиотеки **numpy**, записал их в соответствующие файлы. После этого я вычислял их произвеение с помощью тойже бибилотеки и также записвал результат в файл.

Я написал файл [test.cpp](test.cpp), который считывает эти матрицы в класс *QuadratMatrix*, вычисляет с помощью написанной функции перемножения результирующую матрицу и сравнивает то, что получилось на *Python* и в [моей реализации](myself/QuadratMatrix).
 
### Компиляция и запуск 
Я пользовался компилятором *gcc*, а для генерации тестов и компиляции файлов написал *Makefile*. 

Генерация и компиляция:

```
make all

```

Запуск тестов:

```
./test

```

Запуск демонстрационного примера с 4 потоками:

```
./example 4

```

Очистка директории от результирующих файлов:

```
make clean

```

### Результат тестирования

Листинг запуска тестировочной программы:

```
(base) max@max-Lenovo-B50-30:~/ThreadPool$ make all
g++ -std=c++14 -Wall -pedantic test.cpp -lpthread -o test
python3 generator.py
Generating test:
100%|█████████████████████████████████████████████| 9/9 [00:02<00:00,  3.72it/s]
Test generated!
(base) max@max-Lenovo-B50-30:~/ThreadPool$ ./test
Testing:
Test №1: TRUE
Test №2: TRUE
Test №3: TRUE
Test №4: TRUE
Test №5: TRUE
Test №6: TRUE
Test №7: TRUE
Test №8: TRUE
Test №9: TRUE
All tests correct: TRUE
(base) max@max-Lenovo-B50-30:~/ThreadPool$ make clean 
rm -rf temp/* tests/* test example

```

### Система и софт

**Операционная система:** *Linux Mint 19.3*

**Используемые инсрументы:** Компиляор *g++* стандарта *c++14* версии 7.5.0, а также *Python* 3.6.10 версии с библиотеками **numpy** и **tqdm** для запуска генератора тестов.

-----

##### Made by Max Bronnikov
